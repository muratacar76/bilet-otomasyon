@model List<object>

@{
    ViewData["Title"] = "Rezervasyonlarƒ±m - BULUTBƒ∞LET.COM";
}

<div class="container">
    <div class="page-header">
        <h1>Rezervasyonlarƒ±m</h1>
        <p>T√ºm rezervasyonlarƒ±nƒ±zƒ± buradan g√∂r√ºnt√ºleyebilir ve y√∂netebilirsiniz.</p>
    </div>

    @if (Model == null || !Model.Any())
    {
        <div style="background: linear-gradient(135deg, #00bcd4 0%, #00acc1 100%); color: white; padding: 24px; border-radius: 16px; margin-bottom: 24px; text-align: center;">
            <div style="font-size: 48px; margin-bottom: 16px;">‚úàÔ∏è</div>
            <h3 style="margin-bottom: 12px; font-size: 24px;">Hen√ºz Rezervasyonunuz Bulunmuyor</h3>
            <p style="margin-bottom: 20px; font-size: 16px; opacity: 0.9;">
                ƒ∞lk rezervasyonunuzu yapmak i√ßin u√ßu≈ü aramaya ba≈ülayƒ±n ve en uygun u√ßu≈ülarƒ± ke≈üfedin!
            </p>
            <a asp-controller="Flight" asp-action="Search" class="btn btn-light" style="background: white; color: #00bcd4; padding: 12px 32px; font-size: 16px; border-radius: 12px; text-decoration: none; font-weight: 600; display: inline-block;">
                üîç U√ßu≈ü Ara ve Rezervasyon Yap
            </a>
        </div>
    }
    else
    {
        <div class="bookings-grid">
            @for (int i = 0; i < Model.Count; i++)
            {
                var bookingObj = Model[i];
                var bookingType = bookingObj.GetType();
                
                var bookingId = bookingType.GetProperty("Id")?.GetValue(bookingObj)?.ToString() ?? "0";
                var pnr = bookingType.GetProperty("BookingReference")?.GetValue(bookingObj)?.ToString() ?? "N/A";
                var status = bookingType.GetProperty("Status")?.GetValue(bookingObj)?.ToString() ?? "N/A";
                var flightNumber = bookingType.GetProperty("FlightNumber")?.GetValue(bookingObj)?.ToString() ?? "N/A";
                var airline = bookingType.GetProperty("Airline")?.GetValue(bookingObj)?.ToString() ?? "N/A";
                var departureCity = bookingType.GetProperty("DepartureCity")?.GetValue(bookingObj)?.ToString() ?? "N/A";
                var arrivalCity = bookingType.GetProperty("ArrivalCity")?.GetValue(bookingObj)?.ToString() ?? "N/A";
                var totalPrice = bookingType.GetProperty("TotalPrice")?.GetValue(bookingObj)?.ToString() ?? "0";
                var isPaid = (bool)(bookingType.GetProperty("IsPaid")?.GetValue(bookingObj) ?? false);
                var bookingDate = (DateTime)(bookingType.GetProperty("BookingDate")?.GetValue(bookingObj) ?? DateTime.Now);
                var departureTime = (DateTime)(bookingType.GetProperty("DepartureTime")?.GetValue(bookingObj) ?? DateTime.Now);
                var arrivalTime = (DateTime)(bookingType.GetProperty("ArrivalTime")?.GetValue(bookingObj) ?? DateTime.Now);
                var canBeCancelled = (bool)(bookingType.GetProperty("CanBeCancelled")?.GetValue(bookingObj) ?? false);
                
                <div class="booking-card" style="background: white; border: 1px solid #ddd; border-radius: 12px; padding: 24px; margin: 20px 0; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <div class="booking-header" style="border-bottom: 2px solid #f0f0f0; padding-bottom: 15px; margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h3 style="color: #1976d2; margin: 0;">PNR: @pnr</h3>
                                <p style="margin: 5px 0; color: #666;">@bookingDate.ToString("dd.MM.yyyy HH:mm")</p>
                            </div>
                            <div style="text-align: right;">
                                <span style="background: @(status == "Onaylandƒ±" ? (isPaid ? "#4caf50" : "#ff9800") : "#f44336"); color: white; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: bold;">
                                    @(status == "Onaylandƒ±" ? (isPaid ? "√ñDENDƒ∞" : "ONAYLANDI") : status.ToUpper())
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flight-info" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="color: #333; margin: 0 0 15px 0;">@flightNumber - @airline</h4>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="text-align: center;">
                                <h5 style="color: #1976d2; margin: 0;">@departureCity</h5>
                                <p style="margin: 5px 0; font-weight: bold;">@departureTime.ToString("HH:mm")</p>
                                <small style="color: #666;">@departureTime.ToString("dd.MM.yyyy")</small>
                            </div>
                            <div style="flex: 1; text-align: center; margin: 0 20px;">
                                <div style="font-size: 24px; margin-bottom: 5px;">‚úàÔ∏è</div>
                                <div style="height: 2px; background: #1976d2; border-radius: 1px;"></div>
                            </div>
                            <div style="text-align: center;">
                                <h5 style="color: #1976d2; margin: 0;">@arrivalCity</h5>
                                <p style="margin: 5px 0; font-weight: bold;">@arrivalTime.ToString("HH:mm")</p>
                                <small style="color: #666;">@arrivalTime.ToString("dd.MM.yyyy")</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="booking-footer" style="display: flex; justify-content: space-between; align-items: center; border-top: 2px solid #f0f0f0; padding-top: 15px;">
                        <div>
                            <h4 style="color: #1976d2; margin: 0;">@totalPrice TL</h4>
                            <small style="color: #666;">Toplam Fiyat</small>
                        </div>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            @if (!isPaid)
                            {
                                <button class="btn btn-success" onclick="processPayment('@pnr')" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 6px; font-weight: bold;">
                                    üí≥ √ñde
                                </button>
                            }
                            @if (canBeCancelled)
                            {
                                <button class="btn btn-danger" onclick="cancelBooking('@bookingId', '@pnr')" style="background: #dc3545; color: white; border: none; padding: 10px 20px; border-radius: 6px; font-weight: bold;">
                                    ‚ùå ƒ∞ptal Et
                                </button>
                            }
                            <button class="btn btn-info" onclick="showBookingDetails('@pnr')" style="background: #17a2b8; color: white; border: none; padding: 10px 20px; border-radius: 6px; font-weight: bold;">
                                üìã Detaylar
                            </button>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

<style>
.booking-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    transition: all 0.2s ease;
}

.btn {
    cursor: pointer;
    transition: all 0.2s ease;
    border: none;
    text-decoration: none;
}

.btn:hover {
    opacity: 0.9;
    transform: translateY(-1px);
}

.btn:active {
    transform: translateY(0);
}

.btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

@@media (max-width: 768px) {
    .booking-footer {
        flex-direction: column;
        gap: 15px;
        align-items: flex-start !important;
    }
    
    .booking-footer > div:last-child {
        width: 100%;
    }
    
    .booking-footer > div:last-child > div {
        justify-content: center;
    }
}
</style>

<form method="post" style="display: none;">
    @Html.AntiForgeryToken()
</form>

<script>
function showBookingDetails(pnr) {
    window.location.href = '@Url.Action("Query", "Booking")?pnr=' + pnr;
}

function processPayment(pnr) {
    window.location.href = '@Url.Action("Payment", "Booking")?pnr=' + pnr;
}

function cancelBooking(bookingId, pnr) {
    if (confirm('Bu rezervasyonu iptal etmek istediƒüinizden emin misiniz?\n\nPNR: ' + pnr + '\n\nƒ∞ptal edilen rezervasyonlar geri alƒ±namaz!')) {
        const button = event.target;
        const originalText = button.innerHTML;
        button.innerHTML = '‚è≥ ƒ∞ptal Ediliyor...';
        button.disabled = true;
        
        const userEmail = '@(User.FindFirst(System.Security.Claims.ClaimTypes.Email)?.Value ?? "")';
        
        fetch('/Booking/CancelBooking', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
            },
            body: 'pnr=' + encodeURIComponent(pnr) + '&email=' + encodeURIComponent(userEmail)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('‚úÖ ' + data.message);
                location.reload();
            } else {
                alert('‚ùå ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('‚ùå ƒ∞ptal i≈ülemi sƒ±rasƒ±nda bir hata olu≈ütu.');
        })
        .finally(() => {
            button.innerHTML = originalText;
            button.disabled = false;
        });
    }
}
</script>